<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>È´òËÄÉÊ†∏ÂøÉËØçÊ±á</title>
    <script src="https://lib.baomitu.com/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            alert("‚ùå Á®ãÂ∫èÈîôËØØ:\n" + msg + "\nË°åÂè∑: " + lineNo);
            return false;
        };
    </script>
    <style>
        :root { --bg-color: #fcfcfc; --card-bg: #ffffff; --text-main: #111111; --text-sub: #999999; --border: #f0f0f0; --c-red: #ff6b6b; --c-blue: #339af0; --c-green: #51cf66; --c-orange: #fcc419; }
        body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding-top: env(safe-area-inset-top); }
        button { outline: none; -webkit-tap-highlight-color: transparent; }
        .btn-icon { background: none; border: none; font-size: 20px; cursor: pointer; padding: 10px; color: #333; }
        #auth-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-box { background: transparent; border: none; border-bottom: 1px solid #ddd; padding: 10px; font-size: 18px; text-align: center; width: 220px; outline: none; margin-bottom: 40px; font-weight: 300; }
        .btn-start { background: #000; color: #fff; border: none; padding: 12px 36px; border-radius: 50px; font-size: 14px; cursor: pointer; letter-spacing: 2px; }
        #dashboard-layer { display: none; flex-direction: column; height: 100%; padding: 20px; box-sizing: border-box; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 10px; }
        .deck-card { background: var(--card-bg); border-radius: 8px; padding: 50px 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); cursor: pointer; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 40px; transition: transform 0.2s; }
        .deck-card:active { transform: scale(0.98); }
        .deck-title { font-size: 24px; font-weight: 600; color: #000; letter-spacing: 1px; }
        .stats-row { display: flex; gap: 20px; justify-content: space-around; } 
        .stat-item-dash { display: flex; flex-direction: column; align-items: center; }
        .stat-num { font-size: 32px; font-weight: 700; margin-bottom: 5px; } 
        .stat-label { font-size: 12px; color: #bbb; text-transform: uppercase; letter-spacing: 1px; }
        #stats-layer { display: none; flex-direction: column; height: 100%; background: #fcfcfc; overflow-y: auto; padding: 20px; box-sizing: border-box; z-index: 150; }
        .stats-header { display: flex; align-items: center; margin-bottom: 30px; padding-top: 10px; }
        .section-title { font-size: 14px; font-weight: 600; color: #000; margin: 30px 0 15px; border-left: 3px solid #000; padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .data-card { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #f0f0f0; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .dc-num { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .dc-label { font-size: 12px; color: #999; }
        .chart-controls { display: flex; gap: 10px; }
        .chart-btn { border: 1px solid #eee; background: #fff; padding: 4px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; color: #666; transition: 0.2s; }
        .chart-btn.active { background: #000; color: #fff; border-color: #000; }
        .chart-container { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #f0f0f0; height: 260px; position: relative; }
        #app-layer { display: none; flex-direction: column; height: 100%; background: #fff; }
        
        /* üî• Áä∂ÊÄÅÊ†èÂ∏ÉÂ±ÄÔºö‰∏âÊ†èÂàÜÂ∏É */
        .status-bar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--text-sub); border-bottom: 1px solid var(--border); }
        
        .stage { flex: 1; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .flashcard { width: 85%; height: 65%; background: white; border-radius: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.04); position: relative; transform-style: preserve-3d; transition: transform 0.6s; border: 1px solid #f5f5f5; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; box-sizing: border-box; text-align: center; }
        .back { transform: rotateY(180deg); background: #fff; }
        .speaker-box { width: 80px; height: 80px; border: 1px solid #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; cursor: pointer; transition: 0.2s; }
        .word-en { font-size: 42px; font-weight: 300; margin-bottom: 20px; }
        .word-cn { font-size: 18px; color: #666; font-weight: 300; line-height: 1.6; }
        .actions { height: 100px; background: #fff; display: flex; align-items: center; justify-content: center; gap: 15px; border-top: 1px solid #f9f9f9; padding: 0 20px; transition: opacity 0.2s; }
        .actions.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .btn-opt { flex: 1; max-width: 80px; height: 50px; border-radius: 4px; border: none; font-size: 12px; cursor: pointer; color: #333; background: #f7f7f7; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: transform 0.1s; }
        .btn-opt:active { transform: translateY(2px); }
        .btn-opt span { font-size: 9px; color: #aaa; margin-top: 3px; }
        #error-msg { color: #e74c3c; font-size: 12px; margin-top: 20px; }
        .txt-red { color: var(--c-red); } .txt-green { color: var(--c-green); } .txt-blue { color: var(--c-blue); } .txt-orange { color: var(--c-orange); }
        .g-1 { background: #fff5f5; color: var(--c-red); } .g-2 { background: #fffcf5; color: var(--c-orange); } .g-3 { background: #f5faff; color: var(--c-blue); } .g-4 { background: #f5fbf8; color: var(--c-green); }
        .undo-btn { color: #ccc; cursor: default; transition: 0.3s; margin-left: 15px; } .undo-btn.active { color: #1890ff; cursor: pointer; }
        #toast { visibility: hidden; min-width: 120px; background-color: rgba(0, 0, 0, 0.85); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 300; left: 50%; bottom: 120px; transform: translateX(-50%); font-size: 14px; opacity: 0; }
        #toast.show { visibility: visible; animation: fadeInOut 2s forwards; }
        @keyframes fadeInOut { 0% { opacity: 0; bottom: 120px; } 10% { opacity: 1; bottom: 130px; } 90% { opacity: 1; bottom: 130px; } 100% { opacity: 0; bottom: 120px; } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); } 50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); } }
        .speaker-box.playing { animation: pulse 1s infinite; border-color: #3498db; background-color: #f0f9ff; } .speaker-box.playing svg { fill: #3498db; }
        .sync-status { font-size: 12px; color: #bbb; display: flex; align-items: center; gap: 5px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #eee; transition: 0.3s; }
        .sync-dot.saving { background: #fcc419; animation: blink 1s infinite; } .sync-dot.saved { background: #51cf66; } .sync-dot.error { background: #ff6b6b; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="toast"></div>
    <div id="auth-layer">
        <input type="text" id="code-input" class="input-box" placeholder="ËæìÂÖ•ÊøÄÊ¥ªÁ†Å" spellcheck="false">
        <button class="btn-start" onclick="app.login()" id="login-btn">ËøõÂÖ•</button>
        <p id="error-msg"></p>
    </div>
    <div id="dashboard-layer">
        <div class="dash-header">
            <div class="sync-status"><div class="sync-dot" id="sync-dot"></div><span id="sync-text">Â∑≤Â∞±Áª™</span></div>
            <button class="btn-icon" onclick="app.openStats()">üìä</button>
        </div>
        <div class="deck-card" onclick="app.startSession()">
            <div><div class="deck-title">È´òËÄÉÊ†∏ÂøÉËØçÊ±á</div><div style="font-size:12px; color:#aaa; margin-top:10px;">ÁÇπÂáªÂºÄÂßãÂ≠¶‰π† <span id="loading-status"></span></div></div>
            <div class="stats-row">
                <div class="stat-item-dash"><span class="stat-num txt-red" id="count-due">0</span><span class="stat-label">Â≠¶‰π†Â∫ì</span></div>
                <div class="stat-item-dash"><span class="stat-num txt-blue" id="count-new">0</span><span class="stat-label">Êú™Â≠¶‰π†</span></div>
            </div>
            <div style="text-align:right; color:#ddd;">GO ‚Üí</div>
        </div>
    </div>
    <div id="stats-layer">
        <div class="stats-header"><button class="btn-icon" onclick="app.closeStats()" style="padding-left:0; font-size:24px;">‚Üê</button><div style="font-size:18px; font-weight:600; margin-left:10px;">Â≠¶‰π†Êï∞ÊçÆ</div></div>
        <div class="section-title">‰ªäÊó•Ê¶ÇÂÜµ (Today)</div>
        <div class="data-grid">
            <div class="data-card"><div class="dc-num txt-blue" id="st-today-new">0</div><div class="dc-label">Êñ∞Â≠¶ÂçïËØç</div></div>
            <div class="data-card"><div class="dc-num txt-red" id="st-today-rev">0</div><div class="dc-label">Â§ç‰π†ÂçïËØç</div></div>
            <div class="data-card" style="grid-column: span 2;"><div class="dc-num" style="color:#333" id="st-today-time">0m</div><div class="dc-label">‰ªäÊó•Â≠¶‰π†Êó∂Èïø</div></div>
        </div>
        <div class="section-title">ËÆ∞ÂøÜÂ∫ìÂàÜÂ∏É (State)</div>
        <div class="data-grid">
            <div class="data-card"><div class="dc-num txt-green" id="st-total-mature">0</div><div class="dc-label">ÊàêÁÜüÂçïËØç (>21Â§©)</div></div>
            <div class="data-card"><div class="dc-num txt-orange" id="st-total-young">0</div><div class="dc-label">Â≠¶‰π†‰∏≠ (<21Â§©)</div></div>
            <div class="data-card" style="grid-column: span 2;"><div class="dc-num" style="color:#333" id="st-total-time">0m</div><div class="dc-label">Á¥ØËÆ°ÊäïÂÖ•Êó∂Èó¥</div></div>
        </div>
        <div class="section-title"><span id="chart-title">Â≠¶‰π†Ë∂ãÂäø</span><div class="chart-controls"><button class="chart-btn active" onclick="app.switchChart('week', this)">Êú¨Âë®</button><button class="chart-btn" onclick="app.switchChart('month', this)">Êú¨Êúà</button><button class="chart-btn" onclick="app.switchChart('year', this)">Âπ¥Â∫¶</button></div></div>
        <div class="chart-container"><canvas id="timeChart"></canvas></div>
        <div style="height: 50px;"></div>
    </div>
    <div id="app-layer">
        <div class="status-bar">
            <div style="display:flex; align-items:center;">
                <div onclick="app.backToDash()" style="cursor:pointer;">‚Üê ÊöÇÂÅú</div>
                <div id="btn-undo" class="undo-btn" onclick="app.undo()">‚ü≤ Êí§ÈîÄ</div>
            </div>
            <div style="color:#51cf66; font-size:12px; font-weight:bold;">
                ‚úÖ ‰ªäÊó•: <span id="sess-today">0</span>
            </div>
            <div>
                <span style="color:#3498db; font-size:12px;">‚óè</span> <span id="sess-new">0</span>
                <span style="color:#e74c3c; font-size:12px; margin-left:5px;">‚óè</span> <span id="sess-due">0</span>
            </div>
        </div>
        <div class="stage"><div class="flashcard" id="card" onclick="app.handleCardClick()"><div class="face front"><div class="speaker-box" onclick="app.manualPlay(event)"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></div><div class="hint">ÁÇπÂáªÂê¨Èü≥</div></div><div class="face back"><div class="word-en" id="txt-word">...</div><div class="word-cn" id="txt-mean">...</div><div class="hint" style="margin-top:40px; color:#ddd;">ÁÇπÂáªÁªßÁª≠</div></div></div></div>
        <div class="actions" id="ctrl-bar"><button class="btn-opt g-1" onclick="app.grade(1)">ÂøòËÆ∞<span id="int-1">1m</span></button><button class="btn-opt g-2" onclick="app.grade(2)">Ê®°Á≥ä<span id="int-2">Hard</span></button><button class="btn-opt g-3" onclick="app.grade(3)">ËÆ§ËØÜ<span id="int-3">Good</span></button><button class="btn-opt g-4" onclick="app.grade(4)">ÊéåÊè°<span id="int-4">Easy</span></button></div>
    </div>
    <script>
        const BMOB_APP_ID  = "245c234dd2d5ab723c1f00eaca1474cf";
        const BMOB_API_KEY = "999401489c1ab0d956f5f8db34e97afb";
        
        const FSRS = { 
            p: [0.40255, 1.18385, 3.173, 15.69105, 7.19605, 0.5345, 1.4604, 0.0046, 1.54575, 0.1192, 1.01925, 1.9395, 0.41, 0.6631, 2.33715, 0.2315, 2.9898, 0.51655, 0.6621], 
            requestRetention: 0.9, maxInterval: 36500, 
            nextInterval(s) { return Math.min(Math.max(1, Math.round(s * 9 * (1/this.requestRetention - 1))), this.maxInterval); }, 
            init(rating) { const s = this.p[rating - 1]; let d = this.p[4] - (rating - 3) * this.p[5]; return { s, d: Math.min(Math.max(1, d), 10) }; }, 
            next(d, s, r, rating) { let nextD = Math.min(Math.max(1, (d - this.p[6] * (rating - 3)) * (1 - this.p[7]) + this.p[7] * this.p[4]), 10); let nextS = s; if (rating === 1) nextS = this.p[11] * Math.pow(nextD, -this.p[12]) * (Math.pow(s + 1, this.p[13]) - 1) * Math.exp(this.p[14] * (1 - r)); else { let hardPenalty = rating === 2 ? this.p[15] : 1; let easyBonus = rating === 4 ? this.p[16] : 1; nextS = s * (1 + Math.exp(this.p[8]) * (11 - nextD) * Math.pow(s, -this.p[9]) * (Math.exp(this.p[10] * (1 - r)) - 1) * hardPenalty * easyBonus); } return { s: Number(nextS.toFixed(4)), d: Number(nextD.toFixed(4)) }; }, 
            getRetrievability(s, days) { return Math.pow(1 + days / (9 * s), -1); } 
        };
        
        const app = { 
            user: null, allWords: [], memoryDB: {}, sessionQueue: [], currentCard: null, isFlipped: false, sessionStartTime: 0, chartInstance: null, currentChartMode: 'week', maxNewCards: 99999, actionHistory: [], toastTimer: null,
            // üî• Êñ∞Â¢ûÔºöÊú¨Êó•Â≠¶‰π†ËÆ°Êï∞Âô®
            todayCount: 0,

            async init() { try { const savedCode = localStorage.getItem('anki_code'); if(savedCode) { document.getElementById('code-input').value = savedCode; this.login(); } } catch(e) { alert("Á®ãÂ∫èÂêØÂä®Â§±Ë¥•: " + e.message); } },
            async request(path, method='GET', body=null) { const res = await fetch(`https://api.bmobcloud.com/1/classes/${path}`, { method, headers: { "X-Bmob-Application-Id": BMOB_APP_ID, "X-Bmob-REST-API-Key": BMOB_API_KEY, "Content-Type": "application/json" }, body: body ? JSON.stringify(body) : null }); if(!res.ok) throw new Error("ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥• (‰ª£Á†Å " + res.status + ")"); return await res.json(); },
            async login() { const code = document.getElementById('code-input').value.trim(); const btn = document.getElementById('login-btn'); if(!code) return alert("ËØ∑ËæìÂÖ•ÊøÄÊ¥ªÁ†Å"); btn.textContent = "Âä†ËΩΩ‰∏≠..."; btn.disabled = true; try { const uRes = await this.request(`ActivationCodes?where=${encodeURIComponent(JSON.stringify({code}))}`); if(!uRes.results || uRes.results.length === 0) throw new Error("ÊøÄÊ¥ªÁ†ÅÊó†Êïà"); this.user = uRes.results[0]; localStorage.setItem('anki_code', code); this.memoryDB = this.user.memoryDB || {}; if(!this.user.studyStats) this.user.studyStats = { totalTime: 0, totalRev: 0, todayNew: 0, todayRev: 0, lastDate: "", history: {} }; await this.loadAllWords(btn); this.updateAllCounters(); document.getElementById('auth-layer').style.display = 'none'; document.getElementById('dashboard-layer').style.display = 'flex'; } catch(e) { document.getElementById('error-msg').textContent = e.message; btn.textContent = "ËøõÂÖ•"; btn.disabled = false; localStorage.removeItem('anki_code'); } },
            async loadAllWords(btnElement) { this.allWords = []; let skip = 0; let limit = 500; try { while(true) { if(btnElement) btnElement.textContent = `Âä†ËΩΩ‰∏≠ (${this.allWords.length})...`; const res = await this.request(`Words?order=-rank&limit=${limit}&skip=${skip}`); const batch = res.results || []; this.allWords = this.allWords.concat(this.autoFixData(batch)); if(batch.length < limit) break; skip += limit; } if(btnElement) btnElement.textContent = "Âä†ËΩΩÂÆåÊàê"; const statusEl = document.getElementById('loading-status'); if(statusEl) statusEl.textContent = `(ËØçÂ∫ì: ${this.allWords.length})`; } catch(e) { console.error("ËØçÂ∫ìÂä†ËΩΩ‰∏≠Êñ≠:", e); if(btnElement) btnElement.textContent = "ËØçÂ∫ìÂä†ËΩΩÂ§±Ë¥•"; } },
            
            updateAllCounters() {
                const totalLearned = Object.keys(this.memoryDB).length;
                const totalNew = Math.max(0, this.allWords.length - totalLearned);
                document.getElementById('count-due').textContent = totalLearned; 
                document.getElementById('count-new').textContent = totalNew; 
                document.getElementById('sess-due').textContent = totalLearned;
                document.getElementById('sess-new').textContent = totalNew;
                
                // üî• Êõ¥Êñ∞‰ªäÊó•Â∑≤Â≠¶Êï∞Â≠ó
                document.getElementById('sess-today').textContent = this.todayCount;

                let matureCount = 0, learnCount = 0;
                for (let id in this.memoryDB) { const rec = this.memoryDB[id]; if (rec.interval > 21) matureCount++; else learnCount++; }
                const elMature = document.getElementById('st-total-mature'); if(elMature) elMature.textContent = matureCount; 
                const elYoung = document.getElementById('st-total-young'); if(elYoung) elYoung.textContent = learnCount; 
            },

            isReviewWord(id) { return !!this.memoryDB[id]; },
            isNewWord(id) { return !this.memoryDB[id]; },

            startSession() { 
                this.updateAllCounters(); 
                if(this.allWords.length === 0) return alert("ËØçÂ∫ì‰∏∫Á©∫"); 
                this.sessionQueue = []; 
                const reviewWords = this.allWords.filter(w => this.isReviewWord(w.objectId));
                reviewWords.sort((a, b) => { const rA = this.memoryDB[a.objectId]; const rB = this.memoryDB[b.objectId]; return rA.nextReview - rB.nextReview; });
                const newWords = this.allWords.filter(w => this.isNewWord(w.objectId)); 
                this.sessionQueue = [...reviewWords, ...newWords]; 
                
                if (this.sessionQueue.length === 0) return alert("‰ªäÊó•‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅüéâ"); 
                this.sessionStartTime = Date.now(); 
                this.actionHistory = []; 
                this.todayCount = 0; // ÊØèÊ¨°ÂºÄÂßãÈáçÁΩÆ‰ªäÊó•ËÆ°Êï∞
                this.updateUndoBtn(false); 
                document.getElementById('dashboard-layer').style.display = 'none'; 
                document.getElementById('app-layer').style.display = 'flex'; 
                this.renderNext(); 
            },

            renderNext() { 
                if (this.sessionQueue.length === 0) { alert("Â≠¶‰π†ÂÆåÊàê"); return this.backToDash(); } 
                document.getElementById('card').classList.remove('flipped'); 
                document.getElementById('ctrl-bar').classList.remove('hidden'); 
                this.isFlipped = false; 
                setTimeout(() => { 
                    this.updateAllCounters(); 
                    this.currentCard = this.sessionQueue[0]; 
                    document.getElementById('txt-word').textContent = this.currentCard.f; 
                    document.getElementById('txt-mean').textContent = this.currentCard.b || ""; 
                    this.updateButtonLabels(this.currentCard.objectId); 
                    setTimeout(() => this.playAudio(this.currentCard.f), 200); 
                }, 300); 
            },

            getStepIntervals(record) { return { 1: 1/1440, 2: 5/1440, 3: 10/1440, 4: 1 }; },
            updateButtonLabels(wordId) { const now = Date.now(); let record = this.memoryDB[wordId]; let s = 0, d = 5, lastReview = now; if (record) { if (record.s !== undefined) { s = record.s; d = record.d; lastReview = record.lastReview; } else if (record.interval) { s = record.interval; d = 5; lastReview = now - (record.interval * 86400000); } } const isReview = (s > 0 && record && record.interval >= 1); const daysElapsed = Math.max(0, (now - lastReview) / 86400000); const r = isReview ? FSRS.getRetrievability(s, daysElapsed) : 0; const fmt = (days) => { if (days * 1440 < 60) return Math.round(days*1440) + "m"; if (days < 1) return (days*24).toFixed(1) + "h"; return days >= 365 ? (days/365).toFixed(1)+"y" : (days >= 30 ? (days/30).toFixed(1)+"mo" : Math.round(days)+"d"); }; if (!isReview) { const steps = this.getStepIntervals(record); document.getElementById('int-1').innerText = fmt(steps[1]); document.getElementById('int-2').innerText = fmt(steps[2]); document.getElementById('int-3').innerText = fmt(steps[3]); document.getElementById('int-4').innerText = fmt(steps[4]); } else { const getIv = (r) => { if(r===1) return 0; const res = FSRS.next(d, s, r, r); return FSRS.nextInterval(res.s); }; document.getElementById('int-1').innerText = "1m"; document.getElementById('int-2').innerText = fmt(getIv(2)); document.getElementById('int-3').innerText = fmt(getIv(3)); document.getElementById('int-4').innerText = fmt(getIv(4)); } },
            
            grade(rating) { 
                if (this.isFlipped) return; 
                const wordId = this.currentCard.objectId; 
                
                // 1. Â≠òÂø´ÁÖßÊó∂Ôºå‰πüË¶ÅÂ≠ò todayCount
                const snapshot = { 
                    card: this.currentCard, 
                    dbRecord: this.memoryDB[wordId] ? JSON.parse(JSON.stringify(this.memoryDB[wordId])) : null, 
                    stats: JSON.parse(JSON.stringify(this.user.studyStats)), 
                    queue: [...this.sessionQueue],
                    todayCount: this.todayCount // üî• Â≠ò‰∏ãËøô‰∏™Êï∞Â≠ó
                }; 
                this.actionHistory.push(snapshot); if (this.actionHistory.length > 3) this.actionHistory.shift(); 
                this.updateUndoBtn(true);

                const now = Date.now(); 
                let record = this.memoryDB[wordId]; 
                let s = 0, d = 5, lastReview = now; 
                if (record) { if (record.s !== undefined) { s = record.s; d = record.d; lastReview = record.lastReview || now; } else if (record.interval) { s = record.interval; d = 5; lastReview = now - (record.interval * 86400000); } } 
                const isReviewCard = (s > 0 && record && record.interval >= 1); 
                let nextS = s, nextD = d, interval = 0; 
                if (!isReviewCard) { 
                    const steps = this.getStepIntervals(record); interval = steps[rating]; 
                    if (rating === 4) { const res = FSRS.init(4); nextS = res.s; nextD = res.d; } 
                } else { 
                    const daysElapsed = Math.max(0, (now - lastReview) / 86400000); 
                    const r = FSRS.getRetrievability(s, daysElapsed); 
                    if (rating === 1) { const res = FSRS.next(d, s, r, 1); nextS = res.s; nextD = res.d; interval = 0; } 
                    else { const res = FSRS.next(d, s, r, rating); nextS = res.s; nextD = res.d; interval = FSRS.nextInterval(nextS); } 
                } 
                
                if (rating === 1 && !isReviewCard) {} else { if (isReviewCard) { this.user.studyStats.todayRev++; this.user.studyStats.totalRev++; } else { this.user.studyStats.todayNew++; } } 
                
                let nextReviewTime = now + (interval * 24 * 60 * 60 * 1000); 
                this.memoryDB[wordId] = { s: Number(nextS.toFixed(4)), d: Number(nextD.toFixed(4)), interval: interval, nextReview: nextReviewTime, lastReview: now }; 
                
                this.sessionQueue.shift(); 
                if (interval < 1.0) { 
                    let insertIndex = 3; if(interval > 0.005) insertIndex = 10; insertIndex = Math.min(this.sessionQueue.length, insertIndex); 
                    this.sessionQueue.splice(insertIndex, 0, this.currentCard); 
                } 
                
                this.syncToCloud(); 
                this.isFlipped = true; 
                document.getElementById('card').classList.add('flipped'); 
                document.getElementById('ctrl-bar').classList.add('hidden'); 
                
                // üî• ËÆ°Êï∞Âô® +1
                this.todayCount++;
                this.updateAllCounters(); 
            },

            undo() {
                if (this.actionHistory.length === 0) return;
                const snap = this.actionHistory.pop();
                
                this.user.studyStats = snap.stats;
                if (snap.dbRecord) { this.memoryDB[snap.card.objectId] = snap.dbRecord; } else { delete this.memoryDB[snap.card.objectId]; }
                
                this.sessionQueue = snap.queue; 
                this.currentCard = snap.card; 
                this.isFlipped = false;
                
                // üî• ÊÅ¢Â§çËÆ°Êï∞Âô®
                this.todayCount = snap.todayCount;

                document.getElementById('card').classList.remove('flipped');
                document.getElementById('ctrl-bar').classList.remove('hidden');
                document.getElementById('txt-word').textContent = this.currentCard.f; 
                document.getElementById('txt-mean').textContent = this.currentCard.b || ""; 
                this.updateButtonLabels(this.currentCard.objectId);
                this.updateAllCounters();
                this.syncToCloud();
                this.showToast("‚úÖ Êí§ÈîÄÊàêÂäü");
                if (this.actionHistory.length === 0) { this.updateUndoBtn(false); }
            },

            async syncToCloud() {
                if (this.user) { 
                    const dot = document.getElementById('sync-dot'); const txt = document.getElementById('sync-text');
                    if(dot) { dot.className = "sync-dot saving"; txt.innerText = "‰øùÂ≠ò‰∏≠..."; }
                    const now = Date.now(); const deltaMins = (now - this.sessionStartTime) / 60000; this.sessionStartTime = now; this.user.studyStats.totalTime += deltaMins; const d = new Date(); const dateKey = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); if(!this.user.studyStats.history) this.user.studyStats.history = {}; if(!this.user.studyStats.history[dateKey]) this.user.studyStats.history[dateKey] = 0; this.user.studyStats.history[dateKey] += deltaMins; 
                    try { await this.request(`ActivationCodes/${this.user.objectId}`, 'PUT', { memoryDB: this.memoryDB, studyStats: this.user.studyStats }); if(dot) { dot.className = "sync-dot saved"; txt.innerText = "Â∑≤ÂêåÊ≠•"; } } catch(e) { console.error(e); if(dot) { dot.className = "sync-dot error"; txt.innerText = "ÂêåÊ≠•Â§±Ë¥•"; } alert("‚ö†Ô∏è Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•: " + e.message); }
                } 
            },

            showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; if (this.toastTimer) clearTimeout(this.toastTimer); t.classList.remove("show"); void t.offsetWidth; t.classList.add("show"); this.toastTimer = setTimeout(() => { t.classList.remove("show"); }, 2000); },
            updateUndoBtn(active) { const btn = document.getElementById('btn-undo'); if (active) { btn.classList.add('active'); } else { btn.classList.remove('active'); } },
            openStats() { 
                document.getElementById('dashboard-layer').style.display = 'none'; document.getElementById('stats-layer').style.display = 'flex'; 
                const s = this.user.studyStats; const d = new Date(); const todayKey = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); if(s.lastDate !== todayKey) { s.todayNew = 0; s.todayRev = 0; } 
                document.getElementById('st-today-new').innerText = s.todayNew || 0; document.getElementById('st-today-rev').innerText = s.todayRev || 0; const todayTime = s.history[todayKey] || 0; document.getElementById('st-today-time').innerText = Math.floor(todayTime) + "m"; document.getElementById('st-total-rev').innerText = s.totalRev || 0; document.getElementById('st-total-time').innerText = Math.floor(s.totalTime || 0) + "m"; 
                this.updateAllCounters(); 
                if(typeof Chart !== 'undefined') { this.renderChart(this.currentChartMode); } 
            },
            closeStats() { document.getElementById('stats-layer').style.display = 'none'; document.getElementById('dashboard-layer').style.display = 'flex'; },
            switchChart(mode, btn) { document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); if(typeof Chart !== 'undefined') this.renderChart(mode); },
            renderChart(mode) { const ctx = document.getElementById('timeChart').getContext('2d'); if(this.chartInstance) this.chartInstance.destroy(); let labels = [], data = []; const history = this.user.studyStats.history || {}; const now = new Date(); const currentYear = now.getFullYear(); if (mode === 'week') { const weekDays = ["Âë®‰∏Ä", "Âë®‰∫å", "Âë®‰∏â", "Âë®Âõõ", "Âë®‰∫î", "Âë®ÂÖ≠", "Âë®Êó•"]; let dayOfWeek = now.getDay(); if(dayOfWeek === 0) dayOfWeek = 7; const mondayDate = new Date(now); mondayDate.setDate(now.getDate() - dayOfWeek + 1); for(let i=0; i<7; i++) { const d = new Date(mondayDate); d.setDate(mondayDate.getDate() + i); const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); labels.push(weekDays[i]); data.push(Math.floor(history[key] || 0)); } } else if (mode === 'month') { for(let m=1; m<=12; m++) { labels.push(m + 'Êúà'); const prefix = `${currentYear}-${String(m).padStart(2, '0')}`; let monthTotal = 0; for (let dateKey in history) { if (dateKey.startsWith(prefix)) monthTotal += history[dateKey]; } data.push(Math.floor(monthTotal)); } } else if (mode === 'year') { const regDate = new Date(this.user.createdAt); const startYear = regDate.getFullYear(); for(let y = startYear; y <= currentYear; y++) { labels.push(y + 'Âπ¥'); let yearTotal = 0; for (let dateKey in history) { if (dateKey.startsWith(String(y))) yearTotal += history[dateKey]; } data.push(Math.floor(yearTotal)); } } this.chartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'ÂàÜÈíü', data: data, backgroundColor: '#3498db', borderRadius: 4, barPercentage: 0.6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } }, plugins: { legend: { display: false } } } }); },
            backToDash() { document.getElementById('app-layer').style.display = 'none'; document.getElementById('dashboard-layer').style.display = 'flex'; this.updateAllCounters(); },
            playAudio(text) { const url = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`; const audio = new Audio(url); const speaker = document.querySelector('.speaker-box'); if(speaker) speaker.classList.add('playing'); audio.onended = () => { if(speaker) speaker.classList.remove('playing'); }; audio.onerror = () => { if(speaker) speaker.classList.remove('playing'); }; audio.play().catch(()=>{ if(speaker) speaker.classList.remove('playing'); }); },
            manualPlay(e) { e.stopPropagation(); this.playAudio(this.currentCard.f); },
            autoFixData(rawData) { if(!rawData) return []; return rawData.map(i => ({ f: i.Word || i.f, b: i.Meaning || i.b, rank: i.rank, objectId: i.objectId })); },
            handleCardClick() { if (this.isFlipped) this.renderNext(); else this.playAudio(this.currentCard.f); },
        };
        app.init();
    </script>
</body>
</html>