<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é«˜è€ƒæ ¸å¿ƒè¯æ±‡</title>
    <style>
        :root { 
            --bg-color: #fcfcfc; --card-bg: #ffffff;
            --text-main: #111111; --text-sub: #999999;
            --border: #f0f0f0;
            --green: #27ae60; --blue: #2980b9; --red: #c0392b;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; 
            background: var(--bg-color); color: var(--text-main);
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
            overflow: hidden; -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
        }

        button { outline: none; -webkit-tap-highlight-color: transparent; }

        /* çŠ¶æ€æ  */
        .status-bar {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: var(--text-sub); border-bottom: 1px solid var(--border);
            background: #fff;
        }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.new { background: var(--blue); }
        .dot.due { background: var(--red); }

        /* 1. ç™»å½•å±‚ */
        #auth-layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-color); z-index: 200; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .input-box { 
            background: transparent; border: none; border-bottom: 1px solid #ddd; 
            padding: 10px; font-size: 18px; text-align: center; width: 180px; 
            border-radius: 0; outline: none; margin-bottom: 40px; font-weight: 300;
        }
        .btn-start { 
            background: #000; color: #fff; border: none; padding: 12px 36px; 
            border-radius: 50px; font-size: 14px; cursor: pointer; letter-spacing: 2px;
        }

        /* 2. ä¹¦æ¶å±‚ */
        #dashboard-layer {
            display: none; flex-direction: column; height: 100%; 
            padding: 20px; justify-content: center; 
        }
        .deck-card {
            background: var(--card-bg); border-radius: 4px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); cursor: pointer; border: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 15px;
        }
        .deck-title { font-size: 20px; font-weight: 500; }
        .deck-stats { display: flex; gap: 20px; font-size: 12px; color: #666; }
        .stat-num { font-weight: bold; font-size: 16px; display: block; margin-bottom: 4px; }
        
        /* 3. å­¦ä¹ å±‚ */
        #app-layer { display: none; flex-direction: column; height: 100%; background: #fff; }
        
        .stage { flex: 1; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        
        .flashcard { 
            width: 85%; height: 65%; background: white; border-radius: 4px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.04); position: relative; 
            transform-style: preserve-3d; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
            border: 1px solid #f5f5f5;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; box-sizing: border-box; text-align: center; }
        .back { transform: rotateY(180deg); background: #fff; }

        .speaker-box { 
            width: 80px; height: 80px; border: 1px solid #f0f0f0; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; margin-bottom: 30px; 
            cursor: pointer;
        }
        .speaker-box svg { width: 28px; height: 28px; fill: #222; }

        .word-en { font-size: 42px; font-weight: 300; color: #000; margin-bottom: 20px; }
        .word-cn { font-size: 18px; color: #666; font-weight: 300; line-height: 1.6; }
        .hint { color: #eee; font-size: 11px; margin-top: 25px; text-transform: uppercase; letter-spacing: 2px; }

        .actions { 
            height: 100px; background: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; 
            border-top: 1px solid #f9f9f9; padding: 0 20px;
        }
        .actions.hidden { opacity: 0; pointer-events: none; }

        .btn-opt { 
            flex: 1; height: 54px; border-radius: 4px; border: none; 
            font-size: 12px; font-weight: 500; cursor: pointer; color: #333; background: #f7f7f7; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .btn-opt span { font-size: 10px; color: #999; margin-top: 2px; font-weight: normal; }
        
        .btn-fail { background: #fff5f5; color: #c0392b; }
        .btn-pass { background: #f0f9f4; color: #27ae60; }
        
        #error-msg { color: #e74c3c; font-size: 12px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="auth-layer">
        <input type="text" id="code-input" class="input-box" placeholder="è¾“å…¥æ¿€æ´»ç " spellcheck="false">
        <button class="btn-start" onclick="app.login()" id="login-btn">è¿›å…¥</button>
        <p id="error-msg"></p>
    </div>

    <div id="dashboard-layer">
        <div class="deck-card" onclick="app.startSession()">
            <div class="deck-title">é«˜è€ƒæ ¸å¿ƒè¯æ±‡</div>
            <div style="font-size:13px; color:#999; margin-bottom:15px;">æ— é™æ¨¡å¼ Â· æœ‰å¤šå°‘å­¦å¤šå°‘</div>
            
            <div class="deck-stats">
                <div>
                    <span class="stat-num" style="color:var(--red)" id="count-due">0</span>
                    å¾…å¤ä¹ 
                </div>
                <div>
                    <span class="stat-num" style="color:var(--blue)" id="count-new">0</span>
                    å¾…å­¦æ–°è¯
                </div>
                <div>
                    <span class="stat-num" style="color:var(--green)" id="count-done">0</span>
                    å·²æŒæ¡
                </div>
            </div>
            <div style="margin-top:20px; text-align:right; color:#ddd; font-size:20px;">â†’</div>
        </div>
    </div>

    <div id="app-layer">
        <div class="status-bar">
            <div class="stat-item" onclick="app.backToDash()">â† æš‚åœ</div>
            <div class="stat-item">
                <div class="dot new"></div> <span id="sess-new">0</span>
                <div class="dot due" style="margin-left:10px;"></div> <span id="sess-due">0</span>
            </div>
        </div>

        <div class="stage">
            <div class="flashcard" id="card" onclick="app.flip()">
                <div class="face front">
                    <div class="speaker-box" onclick="app.playAudio(event)">
                        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </div>
                    <div class="hint">ç‚¹å‡»å¬éŸ³</div>
                </div>
                <div class="face back">
                    <div class="word-en" id="txt-word">...</div>
                    <div class="word-cn" id="txt-mean">...</div>
                    <div class="hint" style="color:#ddd; margin-top:40px;">è¯·è¯„åˆ†</div>
                </div>
            </div>
        </div>

        <div class="actions hidden" id="ctrl-bar">
            <button class="btn-opt btn-fail" onclick="app.grade(1)">å¿˜è®°<span>1åˆ†é’Ÿå</span></button>
            <button class="btn-opt" onclick="app.grade(2)">æ¨¡ç³Š<span>1å¤©å</span></button>
            <button class="btn-opt" onclick="app.grade(3)">è®¤è¯†<span>3å¤©å</span></button>
            <button class="btn-opt btn-pass" onclick="app.grade(4)">æŒæ¡<span>7å¤©å</span></button>
        </div>
    </div>

    <script>
        const BMOB_APP_ID  = "245c234dd2d5ab723c1f00eaca1474cf";
        const BMOB_API_KEY = "999401489c1ab0d956f5f8db34e97afb";
        // ğŸš¨ ç§»é™¤äº† DAILY_NEW_LIMITï¼Œç°åœ¨æ˜¯æ— é™æ¨¡å¼

        const app = {
            user: null,
            allWords: [],
            memoryDB: {},
            sessionQueue: [],
            currentCard: null,
            isFlipped: false,

            async request(path, method='GET', body=null) {
                const url = `https://api.bmobcloud.com/1/classes/${path}`;
                const headers = {
                    "X-Bmob-Application-Id": BMOB_APP_ID,
                    "X-Bmob-REST-API-Key": BMOB_API_KEY,
                    "Content-Type": "application/json"
                };
                const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
                if (!res.ok) throw new Error("ç½‘ç»œé”™è¯¯");
                return await res.json();
            },

            async login() {
                const code = document.getElementById('code-input').value.trim();
                const btn = document.getElementById('login-btn');
                
                if(!code) return alert("è¯·è¾“å…¥æ¿€æ´»ç ");
                btn.textContent = "åŒæ­¥æ•°æ®...";
                btn.disabled = true;

                try {
                    const uRes = await this.request(`ActivationCodes?where=${encodeURIComponent(JSON.stringify({code}))}`);
                    if(!uRes.results.length) throw new Error("æ¿€æ´»ç æ— æ•ˆ");
                    this.user = uRes.results[0];
                    this.memoryDB = this.user.memoryDB || {}; 

                    // ä¸‹è½½æ‰€æœ‰å•è¯
                    // ä¸ºäº†æ¼”ç¤ºæµç•…ï¼Œè¿™é‡Œè®¾å®šä¸‹è½½å‰2000ä¸ª (æ ¹æ®ä½ çš„æ•°æ®é‡è°ƒæ•´)
                    const wRes = await this.request('Words?order=-rank&limit=2000');
                    this.allWords = this.autoFixData(wRes.results);

                    this.refreshDashboard();
                    
                    document.getElementById('auth-layer').style.display = 'none';
                    document.getElementById('dashboard-layer').style.display = 'flex';

                } catch(e) {
                    document.getElementById('error-msg').textContent = e.message;
                    btn.textContent = "è¿›å…¥";
                    btn.disabled = false;
                }
            },

            refreshDashboard() {
                const now = Date.now();
                let dueCount = 0;
                let learnedCount = 0;

                const learnedIds = Object.keys(this.memoryDB);
                learnedCount = learnedIds.length;

                // ç»Ÿè®¡åˆ°æœŸå¤ä¹ 
                for (let id in this.memoryDB) {
                    if (this.memoryDB[id].nextReview <= now) {
                        dueCount++;
                    }
                }

                // ğŸ”¥ ç»Ÿè®¡å‰©ä½™æ‰€æœ‰æ–°è¯ (ä¸å†å—é™åˆ¶)
                const newCount = this.allWords.length - learnedCount;

                document.getElementById('count-due').textContent = dueCount;
                document.getElementById('count-new').textContent = newCount > 0 ? newCount : 0;
                document.getElementById('count-done').textContent = learnedCount;
            },

            startSession() {
                const now = Date.now();
                this.sessionQueue = [];

                // 1. å¤ä¹ è¯ (ä¼˜å…ˆ)
                const dueWords = this.allWords.filter(w => {
                    const record = this.memoryDB[w.objectId];
                    return record && record.nextReview <= now;
                });

                // 2. æ–°è¯ (æ‰€æœ‰æœªå­¦è¿‡çš„ï¼Œä¸å†é™åˆ¶æ•°é‡)
                const learnedIds = Object.keys(this.memoryDB);
                const newWords = this.allWords.filter(w => !learnedIds.includes(w.objectId));

                // 3. åˆå¹¶é˜Ÿåˆ—
                this.sessionQueue = [...dueWords, ...newWords];

                if (this.sessionQueue.length === 0) return alert("å¤ªæ£’äº†ï¼æ‰€æœ‰å•è¯éƒ½å­¦å®Œäº†ï¼ğŸ‰");

                document.getElementById('dashboard-layer').style.display = 'none';
                document.getElementById('app-layer').style.display = 'flex';
                this.renderNext();
            },

            renderNext() {
                if (this.sessionQueue.length === 0) {
                    alert("æœ¬æ¬¡ä»»åŠ¡å®Œæˆï¼");
                    return this.backToDash();
                }

                // å®æ—¶æ›´æ–°å‰©ä½™æ•°é‡
                const newCount = this.sessionQueue.filter(w => !this.memoryDB[w.objectId]).length;
                document.getElementById('sess-new').textContent = newCount;
                document.getElementById('sess-due').textContent = this.sessionQueue.length - newCount;

                this.currentCard = this.sessionQueue[0];
                
                document.getElementById('txt-word').textContent = this.currentCard.f;
                document.getElementById('txt-mean').textContent = this.currentCard.b || "";
                
                this.isFlipped = false;
                document.getElementById('card').classList.remove('flipped');
                document.getElementById('ctrl-bar').classList.add('hidden');

                setTimeout(() => this.playAudio(this.currentCard.f), 500);
            },

            flip() {
                if (this.isFlipped) return;
                this.isFlipped = true;
                document.getElementById('card').classList.add('flipped');
                document.getElementById('ctrl-bar').classList.remove('hidden');
            },

            grade(level) {
                const wordId = this.currentCard.objectId;
                const now = Date.now();
                let record = this.memoryDB[wordId] || { interval: 0, nextReview: 0 };

                if (level === 1) { // å¿˜è®°
                    record.interval = 0;
                    record.nextReview = now + 60 * 1000; 
                    // å¿˜è®°çš„è¯ï¼Œæ‰”å›é˜Ÿåˆ—æœ«å°¾ï¼Œç¨åé‡æ¥
                    this.sessionQueue.push(this.currentCard);
                } else {
                    let bonus = 1;
                    if (level === 2) bonus = 1.2;
                    if (level === 3) bonus = 2.5;
                    if (level === 4) bonus = 3.5;

                    let newInterval = (record.interval === 0 ? 1 : record.interval) * bonus;
                    record.interval = Math.round(newInterval);
                    record.nextReview = now + (record.interval * 24 * 60 * 60 * 1000);
                }

                this.memoryDB[wordId] = record;
                this.sessionQueue.shift(); // ç§»é™¤å½“å‰è¯
                this.syncToCloud();
                this.renderNext();
            },

            syncToCloud() {
                if (this.user) {
                    this.request(`ActivationCodes/${this.user.objectId}`, 'PUT', { memoryDB: this.memoryDB });
                }
            },

            backToDash() {
                document.getElementById('app-layer').style.display = 'none';
                document.getElementById('dashboard-layer').style.display = 'flex';
                this.refreshDashboard();
            },

            playAudio(text) {
                const url = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
                new Audio(url).play().catch(()=>{});
            },
            
            manualPlay(e) {
                e.stopPropagation();
                this.playAudio(this.currentCard.f);
            },

            autoFixData(rawData) {
                if (!rawData || !rawData.length) return [];
                const sample = rawData[0];
                if (sample.f && sample.b) return rawData;
                const keys = Object.keys(sample).filter(k => !['objectId','createdAt','updatedAt','ACL','rank'].includes(k));
                let kw=keys[0], km=keys[1]||keys[0];
                for (let k of keys) {
                    if (/[\u4e00-\u9fa5]/.test(sample[k])) km = k;
                    else if (/^[a-zA-Z\s\-\.]+$/.test(sample[k])) kw = k;
                }
                return rawData.map(i => ({ f: i[kw], b: i[km], rank: i.rank, objectId: i.objectId }));
            }
        };
    </script>
</body>
</html>